import { FormEvent, useState } from "react";
import { useMutation, useQuery } from "@tanstack/react-query";
import { getAdaptiveQuiz, getSubjects, submitQuiz } from "../lib/api";
import type { AdaptiveQuizResponse, Subject, SubmitQuizRequest, SubmitQuizResponse } from "../types/api";
const DEFAULT_USER_ID = "demo-user";
const AdaptiveQuizPage = () => {
  const [userId, setUserId] = useState<string>(DEFAULT_USER_ID);
  const [subjectId, setSubjectId] = useState<string>("");
  const [answers, setAnswers] = useState<Record<string, string>>({});
  const { data: subjects } = useQuery<Subject[]>({ queryKey: ["subjects"], queryFn: () => getSubjects() });
  const quizQuery = useMutation<AdaptiveQuizResponse, Error, { userId: string; subjectId: string }>({ mutationFn: ({ userId: uid, subjectId: sid }) => getAdaptiveQuiz(uid, sid) });
  const submitMutation = useMutation<SubmitQuizResponse, Error, SubmitQuizRequest>({ mutationFn: (body) => submitQuiz(body) });
  const handleStartQuiz = (e: FormEvent) => { e.preventDefault(); if (!userId || !subjectId) { return; } setAnswers({}); quizQuery.mutate({ userId, subjectId }); };
  const handleSubmitQuiz = () => { if (!quizQuery.data) { return; } const payload: SubmitQuizRequest = { quizId: quizQuery.data.quizId, userId, answers: quizQuery.data.questions.map((q) => ({ questionId: q.id, selectedOptionId: answers[q.id] })) }; submitMutation.mutate(payload); };
  const quiz = quizQuery.data;
  return (<div className="space-y-6"><div><h2 className="text-xl font-semibold text-text">Adaptive Quiz</h2><p className="text-sm text-muted">Get a difficulty-adjusted quiz based on your performance.</p></div><form onSubmit={handleStartQuiz} className="space-y-4 rounded-lg border border-border bg-card/80 p-4"><div className="grid gap-4 md:grid-cols-3"><div className="flex flex-col gap-1"><label className="text-xs font-medium text-muted" htmlFor="userId">Student ID</label><input id="userId" className="rounded-md border border-border bg-background px-3 py-2 text-sm text-text" value={userId} onChange={(e) => setUserId(e.target.value)} /></div><div className="flex flex-col gap-1"><label className="text-xs font-medium text-muted" htmlFor="subject">Subject</label><select id="subject" className="rounded-md border border-border bg-background px-3 py-2 text-sm text-text" value={subjectId} onChange={(e) => setSubjectId(e.target.value)}><option value="">Select subject</option>{subjects?.map((s) => (<option key={s.id} value={s.id}>{s.name}</option>))}</select></div></div><button type="submit" disabled={quizQuery.isLoading} className="rounded-md bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary/90 disabled:opacity-60">{quizQuery.isLoading ? "Loading quiz..." : "Start quiz"}</button>{quizQuery.isError && (<p className="rounded-md border border-red-300 bg-red-50 px-3 py-2 text-xs text-red-700">{quizQuery.error.message}</p>)}</form>{quiz && (<section className="space-y-4 rounded-lg border border-border bg-card/80 p-4"><header className="flex items-center justify-between"><div><h3 className="text-sm font-semibold text-text">Current quiz</h3><p className="text-xs text-muted">{quiz.questions.length} questions â€¢ adaptive difficulty</p></div><button type="button" className="rounded-md border border-border px-3 py-1 text-xs text-muted hover:border-primary hover:text-primary" onClick={() => quizQuery.reset()}>Reset quiz</button></header><ol className="space-y-3 text-sm">{quiz.questions.map((q, idx) => (<li key={q.id} className="rounded-md border border-border bg-background p-3"><div className="flex items-center justify-between gap-2"><p className="font-medium text-text">Q{idx + 1}. {q.question}</p><span className="text-[10px] uppercase tracking-wide text-muted">{q.difficulty}</span></div><ul className="mt-2 space-y-1">{q.options.map((opt) => (<li key={opt.id} className="flex items-center gap-2"><input type="radio" id={`${q.id}-${opt.id}`} name={q.id} className="h-3 w-3 text-primary" checked={answers[q.id] === opt.id} onChange={() => setAnswers((prev) => ({ ...prev, [q.id]: opt.id }))} /><label htmlFor={`${q.id}-${opt.id}`} className="cursor-pointer text-sm text-text">{opt.text}</label></li>))}</ul></li>))}</ol><button type="button" disabled={submitMutation.isLoading} onClick={handleSubmitQuiz} className="rounded-md bg-secondary px-4 py-2 text-sm font-medium text-white hover:bg-secondary/90 disabled:opacity-60">{submitMutation.isLoading ? "Submitting..." : "Submit quiz"}</button>{submitMutation.isError && (<p className="mt-2 rounded-md border border-red-300 bg-red-50 px-3 py-2 text-xs text-red-700">{submitMutation.error.message}</p>)}{submitMutation.data && (<div className="mt-4 space-y-2 rounded-md border border-border bg-background p-3 text-sm"><p className="font-semibold text-text">Score: {submitMutation.data.score}/{submitMutation.data.totalQuestions}</p>{submitMutation.data.nextRecommendedDifficulty && <p className="text-xs text-muted">Next suggested difficulty: {submitMutation.data.nextRecommendedDifficulty}</p>}</div>)}</section>)}</div>);
};
export default AdaptiveQuizPage;